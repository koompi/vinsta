#!/bin/bash

# Function to check if bun is installed
check_bun_installed() {
  if command -v bun >/dev/null 2>&1; then
    echo "bun is already installed."
  else
    echo "bun is not installed. Installing bun..."
    curl -fsSL https://bun.sh/install | bash
  fi
}

# Function to download and set up vinsta CLI
setup_vinsta_cli() {
  local url="https://github.com/koompi/vinsta/raw/main/client/vinsta/out/index.js"
  local destination="/usr/bin/vinsta"

  echo "Downloading vinsta from $url..."
  curl -L $url -o /tmp/vinsta

  if [ $? -ne 0 ]; then
    echo "Failed to download vinsta. Exiting."
    exit 1
  fi

  echo "Moving vinsta to $destination..."
  sudo mv /tmp/vinsta $destination

  echo "Setting execute permission for $destination..."
  sudo chmod +x $destination

  echo "vinsta has been set up successfully."
}

# Function to install required packages on Arch Linux
install_arch_packages() {
  local arch_packages=(
    curl
    wget
    virt-manager
    virt-viewer
    qemu
    qemu-arch-extra
    edk2-ovmf
    vde2
    ebtables
    dnsmasq
    bridge-utils
    openbsd-netcat
    libguestfs
    guestfs-tools
    expect
    netplan
  )

  echo "Updating package database and installing required packages for Arch Linux..."
  sudo pacman -Syu --needed "${arch_packages[@]}"
}

# Function to install required packages on Ubuntu
install_ubuntu_packages() {
  local ubuntu_packages=(
    curl
    wget
    virt-manager
    virt-viewer
    qemu-system-x86
    qemu-kvm
    libvirt-daemon-system
    bridge-utils
    virtinst
    ovmf
    vde2
    ebtables
    dnsmasq
    netcat-openbsd
    libguestfs-tools
    expect
    netplan
  )

  echo "Updating package database and installing required packages for Ubuntu..."
  sudo apt update
  sudo apt install -y "${ubuntu_packages[@]}"
}

# Main script
check_bun_installed

if command -v pacman &>/dev/null; then
  # Arch Linux detected
  install_arch_packages
elif command -v apt-get &>/dev/null || command -v apt &>/dev/null; then
  # Ubuntu (and Debian-based) detected
  install_ubuntu_packages
else
  echo "Unsupported distribution. Please install required packages manually."
  exit 1
fi

setup_vinsta_cli

echo "Setup completed successfully."
